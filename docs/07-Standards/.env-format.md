# âš™ï¸ MWAP Environment Configuration Format

## ğŸ¯ Overview

This document defines the standard format and requirements for environment variables in the MWAP platform, covering development, staging, and production environments with security best practices and validation requirements.

## ğŸ“‹ Environment File Structure

### **Base Environment Template**
```env
# =============================================================================
# MWAP Environment Configuration
# =============================================================================
# Environment: [development|staging|production]
# Last Updated: [YYYY-MM-DD]
# Maintainer: [team/person responsible]
# =============================================================================

# -----------------------------------------------------------------------------
# APPLICATION SETTINGS
# -----------------------------------------------------------------------------
NODE_ENV=development
PORT=3001
APP_VERSION=1.0.0
APP_NAME=MWAP Server

# -----------------------------------------------------------------------------
# DATABASE CONFIGURATION
# -----------------------------------------------------------------------------
# MongoDB Atlas connection string
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/mwap_dev?retryWrites=true&w=majority

# Database connection options
DB_MAX_POOL_SIZE=10
DB_MIN_POOL_SIZE=2
DB_CONNECTION_TIMEOUT=5000
DB_SOCKET_TIMEOUT=45000

# Database encryption (production only)
DB_ENCRYPTION_ENABLED=false
DB_ENCRYPTION_KEY_ID=
DB_FIELD_ENCRYPTION_KEY=

# -----------------------------------------------------------------------------
# REDIS CONFIGURATION
# -----------------------------------------------------------------------------
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_MAX_RETRIES=3
REDIS_RETRY_DELAY=1000

# -----------------------------------------------------------------------------
# AUTHENTICATION & AUTHORIZATION
# -----------------------------------------------------------------------------
# Auth0 Configuration
AUTH0_DOMAIN=dev-tenant.auth0.com
AUTH0_CLIENT_ID=your_spa_client_id
AUTH0_CLIENT_SECRET=your_spa_client_secret
AUTH0_AUDIENCE=https://api.mwap.local
AUTH0_M2M_CLIENT_ID=your_m2m_client_id
AUTH0_M2M_CLIENT_SECRET=your_m2m_client_secret

# JWT Configuration
JWT_SECRET=your-256-bit-secret-key-here-minimum-32-characters
JWT_EXPIRES_IN=24h
JWT_REFRESH_SECRET=your-refresh-token-secret-256-bits
JWT_REFRESH_EXPIRES_IN=7d

# Session Configuration
SESSION_SECRET=your-session-secret-minimum-32-characters
SESSION_MAX_AGE=1800000
SESSION_SECURE=false
SESSION_HTTP_ONLY=true

# -----------------------------------------------------------------------------
# SECURITY CONFIGURATION
# -----------------------------------------------------------------------------
# Encryption
ENCRYPTION_ALGORITHM=aes-256-gcm
ENCRYPTION_KEY=your-hex-encoded-256-bit-encryption-key-64-characters
HASH_ALGORITHM=argon2id
SALT_ROUNDS=12

# CORS Configuration
API_CORS_ORIGIN=http://localhost:3000,http://localhost:3001
API_CORS_CREDENTIALS=true
API_CORS_METHODS=GET,POST,PUT,DELETE,PATCH,OPTIONS
API_CORS_ALLOWED_HEADERS=Content-Type,Authorization,X-Requested-With,X-CSRF-Token

# Rate Limiting
API_RATE_LIMIT_WINDOW_MS=900000
API_RATE_LIMIT_MAX_REQUESTS=100
API_RATE_LIMIT_SKIP_SUCCESSFUL=false

# Security Headers
HSTS_MAX_AGE=31536000
CSP_POLICY=default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'

# -----------------------------------------------------------------------------
# LOGGING CONFIGURATION
# -----------------------------------------------------------------------------
LOG_LEVEL=debug
LOG_FORMAT=json
LOG_TIMESTAMP=true
LOG_COLORIZE=true

# File Logging
LOG_FILE_ENABLED=true
LOG_FILE_PATH=logs/app.log
LOG_FILE_MAX_SIZE=10m
LOG_FILE_MAX_FILES=5

# Security Logging
SECURITY_LOG_ENABLED=true
SECURITY_LOG_LEVEL=warn
SECURITY_LOG_PATH=logs/security.log

# Audit Logging
AUDIT_LOG_ENABLED=true
AUDIT_LOG_PATH=logs/audit.log
AUDIT_LOG_RETENTION=90d

# -----------------------------------------------------------------------------
# MONITORING & METRICS
# -----------------------------------------------------------------------------
METRICS_ENABLED=true
METRICS_PORT=9090
METRICS_PATH=/metrics

# Health Checks
HEALTH_CHECK_ENABLED=true
HEALTH_CHECK_PATH=/health
HEALTH_CHECK_TIMEOUT=5000

# Performance Monitoring
APM_ENABLED=false
APM_SERVICE_NAME=mwap-server
APM_ENVIRONMENT=development

# -----------------------------------------------------------------------------
# FILE UPLOAD CONFIGURATION
# -----------------------------------------------------------------------------
MAX_FILE_SIZE=10485760
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/gif,application/pdf,text/plain,text/csv
UPLOAD_PATH=uploads/
UPLOAD_TEMP_PATH=temp/
UPLOAD_SCAN_ENABLED=false

# -----------------------------------------------------------------------------
# EXTERNAL SERVICES
# -----------------------------------------------------------------------------
# AWS Configuration
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_S3_BUCKET=mwap-dev-files
AWS_S3_REGION=us-east-1

# Email Service
EMAIL_SERVICE_ENABLED=false
EMAIL_PROVIDER=sendgrid
EMAIL_API_KEY=
EMAIL_FROM_ADDRESS=noreply@mwap.dev
EMAIL_FROM_NAME=MWAP Platform

# Notification Services
SLACK_WEBHOOK_URL=
DISCORD_WEBHOOK_URL=
TEAMS_WEBHOOK_URL=

# -----------------------------------------------------------------------------
# DEVELOPMENT TOOLS
# -----------------------------------------------------------------------------
# Debug Configuration
DEBUG_ENABLED=true
DEBUG_NAMESPACE=mwap:*

# Hot Reload
HOT_RELOAD_ENABLED=true
WATCH_FILES=true

# API Documentation
API_DOCS_ENABLED=true
API_DOCS_PATH=/docs
API_DOCS_TITLE=MWAP API Documentation

# -----------------------------------------------------------------------------
# FEATURE FLAGS
# -----------------------------------------------------------------------------
FEATURE_USER_REGISTRATION=true
FEATURE_EMAIL_VERIFICATION=true
FEATURE_MFA_ENABLED=false
FEATURE_AUDIT_LOGGING=true
FEATURE_RATE_LIMITING=true
FEATURE_FILE_UPLOAD=true
FEATURE_REAL_TIME_SYNC=false

# -----------------------------------------------------------------------------
# TESTING CONFIGURATION
# -----------------------------------------------------------------------------
TEST_DATABASE_URL=mongodb://localhost:27017/mwap_test
TEST_REDIS_URL=redis://localhost:6379/1
TEST_LOG_LEVEL=error
TEST_TIMEOUT=30000
```

## ğŸ”’ Environment-Specific Configurations

### **Development Environment (.env.development)**
```env
NODE_ENV=development
PORT=3001
LOG_LEVEL=debug

# Relaxed security for development
API_CORS_ORIGIN=http://localhost:3000,http://localhost:3001
SESSION_SECURE=false
HSTS_MAX_AGE=0

# Development database
MONGODB_URI=mongodb://localhost:27017/mwap_dev
REDIS_URL=redis://localhost:6379

# Development Auth0
AUTH0_DOMAIN=dev-tenant.auth0.com
AUTH0_AUDIENCE=https://api.mwap.local

# Development features
API_DOCS_ENABLED=true
DEBUG_ENABLED=true
HOT_RELOAD_ENABLED=true
METRICS_ENABLED=true

# Relaxed rate limiting
API_RATE_LIMIT_MAX_REQUESTS=1000
API_RATE_LIMIT_WINDOW_MS=60000

# File upload settings
MAX_FILE_SIZE=52428800
UPLOAD_SCAN_ENABLED=false
```

### **Staging Environment (.env.staging)**
```env
NODE_ENV=staging
PORT=3001
LOG_LEVEL=info

# Staging security
API_CORS_ORIGIN=https://staging.mwap.dev
SESSION_SECURE=true
HSTS_MAX_AGE=86400

# Staging database
MONGODB_URI=mongodb+srv://staging_user:password@staging-cluster.mongodb.net/mwap_staging
REDIS_URL=redis://staging-redis:6379

# Staging Auth0
AUTH0_DOMAIN=staging-tenant.auth0.com
AUTH0_AUDIENCE=https://staging-api.mwap.dev

# Staging features
API_DOCS_ENABLED=true
DEBUG_ENABLED=false
METRICS_ENABLED=true
AUDIT_LOG_ENABLED=true

# Standard rate limiting
API_RATE_LIMIT_MAX_REQUESTS=200
API_RATE_LIMIT_WINDOW_MS=900000

# File upload settings
MAX_FILE_SIZE=10485760
UPLOAD_SCAN_ENABLED=true
```

### **Production Environment (.env.production)**
```env
NODE_ENV=production
PORT=3001
LOG_LEVEL=info

# Production security
API_CORS_ORIGIN=https://app.mwap.dev
SESSION_SECURE=true
HSTS_MAX_AGE=31536000

# Production database with encryption
MONGODB_URI=mongodb+srv://prod_user:secure_password@prod-cluster.mongodb.net/mwap_prod
DB_ENCRYPTION_ENABLED=true
REDIS_URL=redis://prod-redis:6379

# Production Auth0
AUTH0_DOMAIN=prod-tenant.auth0.com
AUTH0_AUDIENCE=https://api.mwap.dev

# Production features
API_DOCS_ENABLED=false
DEBUG_ENABLED=false
METRICS_ENABLED=true
AUDIT_LOG_ENABLED=true
SECURITY_LOG_ENABLED=true

# Strict rate limiting
API_RATE_LIMIT_MAX_REQUESTS=100
API_RATE_LIMIT_WINDOW_MS=900000

# File upload settings
MAX_FILE_SIZE=10485760
UPLOAD_SCAN_ENABLED=true

# Production monitoring
APM_ENABLED=true
APM_SERVICE_NAME=mwap-server
APM_ENVIRONMENT=production
```

## âœ… Environment Validation

### **Validation Schema**
```typescript
// src/config/envValidation.ts
import { z } from 'zod';

const baseEnvSchema = z.object({
  // Application
  NODE_ENV: z.enum(['development', 'staging', 'production']),
  PORT: z.string().transform(Number).pipe(z.number().min(1).max(65535)),
  APP_VERSION: z.string().optional().default('1.0.0'),
  
  // Database
  MONGODB_URI: z.string().startsWith('mongodb'),
  REDIS_URL: z.string().startsWith('redis'),
  
  // Authentication
  AUTH0_DOMAIN: z.string().min(1),
  AUTH0_CLIENT_ID: z.string().min(1),
  AUTH0_CLIENT_SECRET: z.string().min(32),
  AUTH0_AUDIENCE: z.string().url(),
  JWT_SECRET: z.string().min(32),
  
  // Security
  ENCRYPTION_KEY: z.string().length(64).regex(/^[0-9a-fA-F]+$/),
  SESSION_SECRET: z.string().min(32),
  
  // CORS
  API_CORS_ORIGIN: z.string().min(1),
  
  // Rate Limiting
  API_RATE_LIMIT_WINDOW_MS: z.string().transform(Number),
  API_RATE_LIMIT_MAX_REQUESTS: z.string().transform(Number),
  
  // Logging
  LOG_LEVEL: z.enum(['error', 'warn', 'info', 'debug']),
  
  // File Upload
  MAX_FILE_SIZE: z.string().transform(Number),
  ALLOWED_FILE_TYPES: z.string(),
  
  // Features
  METRICS_ENABLED: z.enum(['true', 'false']).transform(val => val === 'true'),
  AUDIT_LOG_ENABLED: z.enum(['true', 'false']).transform(val => val === 'true')
});

const developmentEnvSchema = baseEnvSchema.extend({
  NODE_ENV: z.literal('development'),
  LOG_LEVEL: z.enum(['debug', 'info']).default('debug'),
  API_DOCS_ENABLED: z.enum(['true', 'false']).default('true'),
  DEBUG_ENABLED: z.enum(['true', 'false']).default('true')
});

const stagingEnvSchema = baseEnvSchema.extend({
  NODE_ENV: z.literal('staging'),
  LOG_LEVEL: z.enum(['info', 'warn']).default('info'),
  SESSION_SECURE: z.enum(['true', 'false']).default('true'),
  HSTS_MAX_AGE: z.string().transform(Number).pipe(z.number().min(86400))
});

const productionEnvSchema = baseEnvSchema.extend({
  NODE_ENV: z.literal('production'),
  LOG_LEVEL: z.enum(['info', 'warn', 'error']).default('info'),
  SESSION_SECURE: z.literal('true'),
  HSTS_MAX_AGE: z.string().transform(Number).pipe(z.number().min(31536000)),
  API_DOCS_ENABLED: z.literal('false'),
  DEBUG_ENABLED: z.literal('false'),
  DB_ENCRYPTION_ENABLED: z.enum(['true', 'false']).default('true'),
  SECURITY_LOG_ENABLED: z.literal('true')
});

export function validateEnvironment() {
  const env = process.env.NODE_ENV;
  
  try {
    switch (env) {
      case 'development':
        return developmentEnvSchema.parse(process.env);
      case 'staging':
        return stagingEnvSchema.parse(process.env);
      case 'production':
        return productionEnvSchema.parse(process.env);
      default:
        throw new Error(`Unknown NODE_ENV: ${env}`);
    }
  } catch (error) {
    console.error('âŒ Environment validation failed:', error);
    process.exit(1);
  }
}
```

### **Environment Validation Script**
```bash
#!/bin/bash
# scripts/validate-env.sh

set -e

ENV_FILE=${1:-.env}

echo "ğŸ” Validating environment file: $ENV_FILE"

# Check if file exists
if [ ! -f "$ENV_FILE" ]; then
    echo "âŒ Environment file not found: $ENV_FILE"
    exit 1
fi

# Check for required variables
REQUIRED_VARS=(
    "NODE_ENV"
    "PORT"
    "MONGODB_URI"
    "AUTH0_DOMAIN"
    "AUTH0_CLIENT_ID"
    "AUTH0_CLIENT_SECRET"
    "JWT_SECRET"
    "ENCRYPTION_KEY"
    "SESSION_SECRET"
)

for var in "${REQUIRED_VARS[@]}"; do
    if ! grep -q "^${var}=" "$ENV_FILE"; then
        echo "âŒ Missing required variable: $var"
        exit 1
    fi
done

# Check for empty values
if grep -q "^[A-Z_]*=$" "$ENV_FILE"; then
    echo "âŒ Found empty environment variables:"
    grep "^[A-Z_]*=$" "$ENV_FILE"
    exit 1
fi

# Check secret lengths
JWT_SECRET=$(grep "^JWT_SECRET=" "$ENV_FILE" | cut -d'=' -f2)
if [ ${#JWT_SECRET} -lt 32 ]; then
    echo "âŒ JWT_SECRET must be at least 32 characters"
    exit 1
fi

ENCRYPTION_KEY=$(grep "^ENCRYPTION_KEY=" "$ENV_FILE" | cut -d'=' -f2)
if [ ${#ENCRYPTION_KEY} -ne 64 ]; then
    echo "âŒ ENCRYPTION_KEY must be exactly 64 hex characters"
    exit 1
fi

# Check for development settings in production
NODE_ENV=$(grep "^NODE_ENV=" "$ENV_FILE" | cut -d'=' -f2)
if [ "$NODE_ENV" = "production" ]; then
    if grep -q "^DEBUG_ENABLED=true" "$ENV_FILE"; then
        echo "âŒ DEBUG_ENABLED should be false in production"
        exit 1
    fi
    
    if grep -q "^API_DOCS_ENABLED=true" "$ENV_FILE"; then
        echo "âŒ API_DOCS_ENABLED should be false in production"
        exit 1
    fi
    
    if grep -q "^LOG_LEVEL=debug" "$ENV_FILE"; then
        echo "âŒ LOG_LEVEL should not be debug in production"
        exit 1
    fi
fi

echo "âœ… Environment validation passed"
```

## ğŸ” Security Best Practices

### **Secret Management**
```bash
# Generate secure secrets
generate_jwt_secret() {
    openssl rand -base64 32
}

generate_encryption_key() {
    openssl rand -hex 32
}

generate_session_secret() {
    openssl rand -base64 48
}

# Example usage
echo "JWT_SECRET=$(generate_jwt_secret)"
echo "ENCRYPTION_KEY=$(generate_encryption_key)"
echo "SESSION_SECRET=$(generate_session_secret)"
```

### **Environment File Security**
```bash
# Set proper permissions
chmod 600 .env*

# Add to .gitignore
echo ".env*" >> .gitignore
echo "!.env.example" >> .gitignore

# Encrypt sensitive environment files
gpg --symmetric --cipher-algo AES256 .env.production
```

### **Docker Secrets Integration**
```yaml
# docker-compose.yml with secrets
version: '3.8'

services:
  mwap-app:
    image: mwap-server:latest
    environment:
      - NODE_ENV=production
      - PORT=3001
    secrets:
      - mongodb_uri
      - jwt_secret
      - encryption_key
    command: sh -c "
      export MONGODB_URI=$$(cat /run/secrets/mongodb_uri) &&
      export JWT_SECRET=$$(cat /run/secrets/jwt_secret) &&
      export ENCRYPTION_KEY=$$(cat /run/secrets/encryption_key) &&
      node dist/server.js
    "

secrets:
  mongodb_uri:
    file: ./secrets/mongodb_uri.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  encryption_key:
    file: ./secrets/encryption_key.txt
```

## ğŸ§ª Testing Environment Configuration

### **Test Environment Setup**
```typescript
// src/test/setupEnv.ts
import dotenv from 'dotenv';
import path from 'path';

// Load test environment
dotenv.config({ path: path.join(__dirname, '../../.env.test') });

// Override with test-specific values
process.env.NODE_ENV = 'test';
process.env.MONGODB_URI = 'mongodb://localhost:27017/mwap_test';
process.env.REDIS_URL = 'redis://localhost:6379/1';
process.env.LOG_LEVEL = 'error';
process.env.JWT_SECRET = 'test-jwt-secret-32-characters-long';
process.env.ENCRYPTION_KEY = '0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef';
process.env.SESSION_SECRET = 'test-session-secret-32-characters';
process.env.AUTH0_DOMAIN = 'test-tenant.auth0.com';
process.env.AUTH0_CLIENT_ID = 'test-client-id';
process.env.AUTH0_CLIENT_SECRET = 'test-client-secret-32-characters-long';
process.env.AUTH0_AUDIENCE = 'https://api.mwap.test';
```

### **Environment Testing**
```typescript
// src/config/__tests__/env.test.ts
import { validateEnvironment } from '../envValidation';

describe('Environment Validation', () => {
  const originalEnv = process.env;

  beforeEach(() => {
    jest.resetModules();
    process.env = { ...originalEnv };
  });

  afterAll(() => {
    process.env = originalEnv;
  });

  it('should validate development environment', () => {
    process.env.NODE_ENV = 'development';
    process.env.PORT = '3001';
    process.env.MONGODB_URI = 'mongodb://localhost:27017/test';
    process.env.REDIS_URL = 'redis://localhost:6379';
    process.env.AUTH0_DOMAIN = 'test.auth0.com';
    process.env.AUTH0_CLIENT_ID = 'test-client-id';
    process.env.AUTH0_CLIENT_SECRET = 'test-client-secret-32-characters-long';
    process.env.AUTH0_AUDIENCE = 'https://api.test.com';
    process.env.JWT_SECRET = 'test-jwt-secret-32-characters-long';
    process.env.ENCRYPTION_KEY = '0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef';
    process.env.SESSION_SECRET = 'test-session-secret-32-characters';
    process.env.API_CORS_ORIGIN = 'http://localhost:3000';
    process.env.API_RATE_LIMIT_WINDOW_MS = '900000';
    process.env.API_RATE_LIMIT_MAX_REQUESTS = '100';
    process.env.LOG_LEVEL = 'debug';
    process.env.MAX_FILE_SIZE = '10485760';
    process.env.ALLOWED_FILE_TYPES = 'image/jpeg,image/png';
    process.env.METRICS_ENABLED = 'true';
    process.env.AUDIT_LOG_ENABLED = 'true';

    expect(() => validateEnvironment()).not.toThrow();
  });

  it('should reject invalid JWT secret length', () => {
    process.env.NODE_ENV = 'development';
    process.env.JWT_SECRET = 'short'; // Too short

    expect(() => validateEnvironment()).toThrow();
  });

  it('should reject invalid encryption key format', () => {
    process.env.NODE_ENV = 'development';
    process.env.ENCRYPTION_KEY = 'invalid-key'; // Wrong format

    expect(() => validateEnvironment()).toThrow();
  });

  it('should require HTTPS in production', () => {
    process.env.NODE_ENV = 'production';
    process.env.API_CORS_ORIGIN = 'http://app.mwap.dev'; // HTTP not allowed

    expect(() => validateEnvironment()).toThrow();
  });
});
```

## ğŸ“ Environment Documentation

### **Environment Variables Reference**
| Variable | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `NODE_ENV` | enum | âœ… | - | Application environment (development/staging/production) |
| `PORT` | number | âœ… | - | Server port number |
| `MONGODB_URI` | string | âœ… | - | MongoDB connection string |
| `REDIS_URL` | string | âœ… | - | Redis connection URL |
| `AUTH0_DOMAIN` | string | âœ… | - | Auth0 tenant domain |
| `AUTH0_CLIENT_ID` | string | âœ… | - | Auth0 application client ID |
| `AUTH0_CLIENT_SECRET` | string | âœ… | - | Auth0 application client secret |
| `AUTH0_AUDIENCE` | string | âœ… | - | Auth0 API audience |
| `JWT_SECRET` | string | âœ… | - | JWT signing secret (min 32 chars) |
| `ENCRYPTION_KEY` | string | âœ… | - | Data encryption key (64 hex chars) |
| `SESSION_SECRET` | string | âœ… | - | Session signing secret (min 32 chars) |
| `API_CORS_ORIGIN` | string | âœ… | - | Allowed CORS origins (comma-separated) |
| `LOG_LEVEL` | enum | âŒ | info | Logging level (error/warn/info/debug) |
| `MAX_FILE_SIZE` | number | âŒ | 10485760 | Maximum file upload size in bytes |
| `METRICS_ENABLED` | boolean | âŒ | true | Enable metrics collection |
| `AUDIT_LOG_ENABLED` | boolean | âŒ | true | Enable audit logging |

### **Environment Setup Checklist**
- [ ] Copy `.env.example` to `.env`
- [ ] Generate secure secrets using provided scripts
- [ ] Configure Auth0 tenant and applications
- [ ] Set up MongoDB Atlas cluster
- [ ] Configure Redis instance
- [ ] Validate environment using validation script
- [ ] Test application startup
- [ ] Verify all features work correctly
- [ ] Set proper file permissions (600)
- [ ] Add environment files to .gitignore
- [ ] Document any custom variables

## ğŸ”— Related Documentation

- **[ğŸ›¡ï¸ Security Configuration](../04-Backend/security-configuration.md)** - Security setup details
- **[ğŸš€ Deployment Guide](../06-Guides/how-to-deploy.md)** - Deployment procedures
- **[ğŸ” Auth0 Integration](../06-Guides/how-to-integrate-auth0.md)** - Authentication setup
- **[ğŸ§ª Testing Strategy](../06-Guides/testing-strategy.md)** - Testing configuration
- **[ğŸ—ï¸ Development Guide](./development-guide.md)** - Development setup

---

*This environment configuration format ensures consistent, secure, and maintainable environment management across all MWAP platform deployments.*